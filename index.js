// ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡ßÄ‡ßü ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø ‡¶á‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
const { Telegraf, Markup } = require('telegraf');
const axios = require('axios');
require('dotenv').config(); // .env ‡¶´‡¶æ‡¶á‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶≠‡ßç‡¶Ø‡¶æ‡¶∞‡¶ø‡ßü‡ßá‡¶¨‡¶≤ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø

// --- ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶≠‡ßç‡¶Ø‡¶æ‡¶∞‡¶ø‡ßü‡ßá‡¶¨‡¶≤ ---
const BOT_TOKEN = process.env.BOT_TOKEN;
const TMDB_API_KEY = process.env.TMDB_API_KEY;
const JOIN_CHANNEL_USERNAME = '@NarutoAllSeasonDownload'; // ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶ï‡ßá ‡¶Ø‡ßá ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá
const SOURCE_CHANNEL_USERNAME = '@movieDownload1212';   // ‡¶Ø‡ßá‡¶ñ‡¶æ‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶´‡¶æ‡¶á‡¶≤ ‡¶ï‡¶™‡¶ø/‡¶°‡¶ø‡¶ü‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá
const TARGET_CHANNEL_USERNAME = '@NarutoAllSeasonDownload'; // ‡¶Ø‡ßá‡¶ñ‡¶æ‡¶®‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶¨‡ßá

// ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã‡¶á ‡¶∏‡¶ï‡¶≤ ‡¶∏‡¶ø‡¶®‡ßá‡¶Æ‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶Æ‡ßá‡¶∞ Message ID ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
const LINK_MOVIE_ANIME_IDS = {
    // Anime start from here
    "lookism_season_1":[858,859,860,861,862,863,864,865],
    "spy":[869,870,871,872,873,874,875,876,877,878,879,880,881,882,883,884,885,886,887,888,889,890,891,892,893],
    "naruto_shi_s1":[74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,103,104,105,106],
    "naruto_shi_s2":[125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145],
    "naruto_shi_s3":[41,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,62,63,64,65,66,67,68,69,70],
    "naruto_shi_s4":[209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225],
    "naruto_shi_s5":[184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207],
    "naruto_shi_s6":[238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268],
    "naruto_shi_s7":[228,229,230,231,232,233,234,235],
    "naruto_shi_s8":[294,295,296,297,298,299,300,301,302,303,304,305,306,307,308,309,310,311,312,314,315,316,317],
    "naruto_shi_s9":[271,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,289,290,291],
    "naruto_s1":[625,626,627,628,629,630,631,632,633,634,635,636,637,638,639,640,641,642,643,644,645,646,647,648,649,650],
    "naruto_s2":[653,654,655,656,657,658,659,660,661,662,663,664,665,666,667,668,669,670,671,672,673,674,675,676,677,678],
    "naruto_s3":[684,685,686,687,688,689,690,691,692,693,694,695,696,697,698,699,700,701,702,703,704,705,706,707,708,709,710,711],
    "naruto_s4":[742],
    "naruto_s5":[713,714,715,716,717,718,719,720,721,722,723,724,725,726,727,728,729,730,731,732,733,734,735,736,737,738,739,740],
    "naruto_s6":[744,745,746,747,748,749,750,751,752,753,754,755,756,757,758,759,760,761,762,763,764,765,766,767],
    "naruto_s7":[805,806,807,808,809,810,811,812,813,814,815,816,817,818,819,820,821,822,823,824,825,826,827,828,829,830],
    "naruto_s8":[769,770,771,772,773,774,775,776,777,778,779,780,781,782,783,784,785,786,787,788,789,790,791,792,793,794],
    "naruto_s9":[796,797,798,799,800,801,802,803],
    "juju_s1":[10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38],
    "juju_s2":[159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181],
    "ato_s1":[381,382,383,384,385,386,387,388,389,390,391,392,393,394,395,396,397,398,399,400,401,402,403,404,405],
    "ato_s2":[411,412,413,414,145,416,417,418,419,420,421,422],
    "ato_s3":[425,426,427,428,429,430,431,432,433,434,435,436,437,438,439,440,441,442,443,444,455],
    "ato_s4":[458,459,460,461,462,463,464,465,466,467,468,469,470,471,472,473,474,475,476,477,478,479,480,481,482,483,484,485],
    "db_s1":[488,489,490,491,492,493,494,495,496,497,498,499,500,501],
    "db_s2":[548,549,550,551,552,553,554,555,556,557,558,559,560],
    "db_s3":[527,528,529,530,531,532,533,534,535,536,537,538,339,540,541,542,543,544,545],
    "db_s4":[505,506,507,508,509,510,511,512,513,514,515,516,517,518,519,520,521,522,523,524],
    "db_s5":[563,564,565,566,567,568,569,570,571,572,573,574,575,576,577,578,579,580,581,582,583,584,585,586,587,588,589,590,591,592,593,594,595,596,597,598,599,600,601,602,603,604,605,606,607,608,609,610,611,612,613,614,615,616,617],
    "demon_s1":[343,344,345,346,347,348,349,350,351,352,353,354,355,356,357,358,359,360,361,362,363,364,365,366,367,368],
    "demon_s2":[323,324,325,326,327,328,329,330,331,332,333,334,335,336,337,338,339,340],
    "demon_s3":[],
    "demon_s4":[371,372,373,374,375,376,377,378],
    "solo_s1": [], // Empty array as per original code
    "solo_s2": [], // Empty array as per original code

    // movie start from here
    "screech": 123, "jujutsu": 621, "opred": 789, "rock":407, "animal": 897,
    "dragon":408, "fighter":504, "taare":895, "bor":623, "dangal":867,
    "sikandar":915, "ace": 916, "lop_nor_tomb": 918, "odela_railway_station": 991
};

// Telegraf ‡¶¨‡¶ü ‡¶Ö‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
const bot = new Telegraf(BOT_TOKEN);

// --- Helper Functions (Manual Menu) ---

const sendEpisodes = async (ctx, episodeIds, seasonName) => {
    if (!episodeIds || episodeIds.length === 0) {
        return ctx.reply(` ‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ${seasonName}-‡¶è‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶∞‡ßç‡¶¨ ‡¶è‡¶ñ‡¶® ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§`);
    }
    await ctx.reply(`‚¨áÔ∏è ${seasonName} ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá... ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`);
    try {
        for (const msg_id of episodeIds) {
            await ctx.telegram.copyMessage(ctx.chat.id, SOURCE_CHANNEL_USERNAME, msg_id);
        }
        await ctx.reply(`‚úÖ ${seasonName}-‡¶è‡¶∞ ‡¶∏‡¶¨ ‡¶è‡¶™‡¶ø‡¶∏‡ßã‡¶° ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá!`);
    } catch (error) {
        console.error(`Error sending episodes for ${seasonName}:`, error);
        await ctx.reply('‚ùå ‡¶è‡¶™‡¶ø‡¶∏‡ßã‡¶° ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
    }
};

const sendMovie = async (ctx, movieId, movieName) => {
    await ctx.reply(`‚¨áÔ∏è ${movieName} ‡¶Æ‡ßÅ‡¶≠‡¶ø‡¶ü‡¶ø ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá...`);
    try {
        await ctx.telegram.copyMessage(ctx.chat.id, SOURCE_CHANNEL_USERNAME, movieId);
        await ctx.reply(`‚úÖ ${movieName} ‡¶Æ‡ßÅ‡¶≠‡¶ø‡¶ü‡¶ø ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá!`);
    } catch (error) {
        console.error(`Error sending movie ${movieName}:`, error);
        await ctx.reply('‚ùå ‡¶Æ‡ßÅ‡¶≠‡¶ø‡¶ü‡¶ø ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
    }
}

// --- Helper Functions (Automatic Posting) ---

const searchMovieData = async (movieName) => {
    try {
        const url = `https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(movieName)}`;
        const response = await axios.get(url);
        if (response.data.results && response.data.results.length > 0) {
            return response.data.results[0]; // Return the first result
        }
        return null;
    } catch (error) {
        console.error("TMDB API Error:", error.message);
        return null;
    }
};

const createMovieCaption = (movieData, quality, audio) => {
    let caption = `‚ñ∂ Name : üìΩÔ∏è ${movieData.title}\n`;
    caption += `‚ñ∂ Quality : ${quality}\n`;
    caption += `‚ñ∂ Audio : ${audio}\n`;
    caption += `#official\n`;
    caption += `___________________\n\n`;
    caption += `Download Now:`;
    return caption;
};

// --- Middleware for Force Join ---
const forceJoinMiddleware = async (ctx, next) => {
    try {
        const chatMember = await ctx.telegram.getChatMember(JOIN_CHANNEL_USERNAME, ctx.from.id);
        const validStatuses = ["member", "administrator", "creator"];
        if (validStatuses.includes(chatMember.status)) {
            return next();
        } else {
            await ctx.reply(
                "‚ùó ‡¶¨‡¶ü ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶™‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‚úÖ I Have Joined ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®‡•§",
                Markup.inlineKeyboard([
                    [Markup.button.url('üîó Join Channel', `https://t.me/${JOIN_CHANNEL_USERNAME.substring(1)}`)],
                    [Markup.button.callback('‚úÖ I Have Joined', 'check_join')]
                ])
            );
        }
    } catch (error) {
        console.error("Force join check error:", error);
        await ctx.reply("‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Æ‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡¶∂‡¶ø‡¶™ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶¨‡¶ü‡¶ü‡¶ø ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Ü‡¶õ‡ßá‡•§");
    }
};

// --- Bot Event Listener for Automatic Posting ---

bot.on('channel_post', async (ctx) => {
    if (ctx.channelPost.chat.username === SOURCE_CHANNEL_USERNAME.substring(1)) {
        const post = ctx.channelPost;
        if (post.video || post.document) {
            const file = post.video || post.document;
            const messageId = post.message_id;

            let movieName = (file.file_name || "Untitled").split('.').slice(0, -1).join('.').replace(/[\._]/g, ' ');
            let quality = "720p";
            if (movieName.match(/1080p/i)) quality = "1080p";
            if (movieName.match(/480p/i)) quality = "480p";
            let audio = "Hindi";
            if (movieName.match(/english|eng/i)) audio = "English";
            
            movieName = movieName.replace(/(1080p|720p|480p|hindi|dual audio|bluray|hdrip|webrip)/ig, '').trim();
            console.log(`‡¶∏‡ßç‡¶¨‡¶Ø‡¶º‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶≠‡¶æ‡¶¨‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶Æ‡ßÅ‡¶≠‡¶ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶õ‡ßá: ${movieName}`);

            const movieData = await searchMovieData(movieName);

            if (movieData && movieData.poster_path) {
                const posterUrl = `https://image.tmdb.org/t/p/w500${movieData.poster_path}`;
                const caption = createMovieCaption(movieData, quality, audio);
                const botUsername = (await ctx.telegram.getMe()).username;
                const deeplink = `https://t.me/${botUsername}?start=file_${messageId}`;

                try {
                    await ctx.telegram.sendPhoto(
                        TARGET_CHANNEL_USERNAME,
                        { url: posterUrl },
                        {
                            caption: caption,
                            ...Markup.inlineKeyboard([
                                [Markup.button.url('Click Here to Download', deeplink)]
                            ])
                        }
                    );
                    console.log(`"${movieData.title}" ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ${TARGET_CHANNEL_USERNAME} ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
                } catch (e) {
                    console.error("‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•:", e.message);
                }
            } else {
                console.log(`"${movieName}" ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø TMDB-‡¶§‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§`);
            }
        }
    }
});

// --- Bot Commands ---

bot.start(forceJoinMiddleware, async (ctx) => {
    const payload = ctx.startPayload;

    // ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶¨‡¶Ø‡¶º‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶°‡¶ø‡¶™-‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶≤ ‡¶ï‡¶∞‡¶æ (`?start=file_123`)
    if (payload && payload.startsWith('file_')) {
        const messageId = parseInt(payload.split('_')[1], 10);
        if (!isNaN(messageId)) {
            await ctx.reply("‚¨áÔ∏è ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá... ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
            try {
                // "Forwarded from" ‡¶õ‡¶æ‡ßú‡¶æ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø copyMessage ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
                await ctx.telegram.copyMessage(ctx.chat.id, SOURCE_CHANNEL_USERNAME, messageId);
                await ctx.reply("‚úÖ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            } catch (error) {
                console.error("‡¶´‡¶æ‡¶á‡¶≤ ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ:", error.message);
                await ctx.reply("‚ùå ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶è‡¶ü‡¶ø ‡¶π‡ßü‡¶§‡ßã ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
            }
        }
        return;
    }

    // ‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶≤ ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶°‡¶ø‡¶™-‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶≤ ‡¶ï‡¶∞‡¶æ (`?start=naruto_s1`)
    if (payload && LINK_MOVIE_ANIME_IDS[payload]) {
        const ids = LINK_MOVIE_ANIME_IDS[payload];
        const name = payload.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        if (Array.isArray(ids)) {
            await sendEpisodes(ctx, ids, name);
        } else {
            await sendMovie(ctx, ids, name);
        }
        return;
    }
    
    // ‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶ø‡¶™-‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶ü ‡¶Æ‡ßá‡¶®‡ßÅ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
    await ctx.reply("What do you want to download?", Markup.inlineKeyboard([
        [Markup.button.callback("üé¨ Movie", "show_movie")],
        [Markup.button.callback("üç• Anime", "show_anime")]
    ]));
});

// ‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã ‡¶ï‡ßã‡¶°‡ßá‡¶∞ ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶°‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§ ‡¶•‡¶æ‡¶ï‡¶õ‡ßá
bot.command('help', (ctx) => { ctx.reply("‚ÑπÔ∏è Bot Commands:\n/start - ‡¶¨‡¶ü ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®\n/help - ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶Æ‡ßá‡¶®‡ßÅ\n/about - ‡¶¨‡¶ü ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá\n/premium - ‡¶™‡ßç‡¶∞‡¶ø‡¶Æ‡¶ø‡ßü‡¶æ‡¶Æ ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá ‡¶ú‡¶æ‡¶®‡ßÅ‡¶®"); });
bot.command('about', (ctx) => { ctx.reply("ü§ñ ‡¶è‡¶á ‡¶¨‡¶ü‡¶ü‡¶ø ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡ßÅ‡¶≠‡¶ø ‡¶ì ‡¶è‡¶®‡¶ø‡¶Æ‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶§‡ßà‡¶∞‡¶ø‡•§\n‚úÖ ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞, ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶á‡¶â‡¶ú‡¶æ‡¶∞-‡¶´‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶≤‡¶ø ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶´‡ßá‡¶∏!"); });
bot.command('premium', (ctx) => { ctx.reply("üíé Premium ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞:\n- ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°\n- Ad-free experience\n- Exclusive ‡¶è‡¶®‡¶ø‡¶Æ‡ßá/‡¶Æ‡ßÅ‡¶≠‡¶ø\n‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®: @YourSupportBot"); });

// --- Callback Query Handlers (Button Clicks) ---

bot.action('check_join', async (ctx) => {
    await ctx.answerCbQuery();
    try {
        const chatMember = await ctx.telegram.getChatMember(JOIN_CHANNEL_USERNAME, ctx.from.id);
        const validStatuses = ["member", "administrator", "creator"];
        if (validStatuses.includes(chatMember.status)) {
            await ctx.deleteMessage();
            await ctx.reply("‚úÖ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶ú‡ßü‡ßá‡¶® ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            await ctx.reply("What do you want to download?", Markup.inlineKeyboard([
                [Markup.button.callback("üé¨ Movie", "show_movie")],
                [Markup.button.callback("üç• Anime", "show_anime")]
            ]));
        } else {
            await ctx.reply("‚ùå ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶ñ‡¶®‡ßã ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡ßá‡¶®‡¶®‡¶ø‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        }
    } catch (e) {
        console.error(e);
        await ctx.reply("‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡ßü ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§");
    }
});

// ‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã ‡¶ï‡ßã‡¶°‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ö‡¶Ç‡¶∂ ‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§
bot.action('show_movie', async (ctx) => {
    await ctx.answerCbQuery();
    await ctx.editMessageText("üìΩÔ∏è ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶≠‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®:", Markup.inlineKeyboard([
        [Markup.button.callback("üé¨ Dragon", "movie_dragon"), Markup.button.callback("üé¨ Rockstar", "movie_rock")],
        [Markup.button.callback("üé¨ Fighter", "movie_fighter"), Markup.button.callback("üé¨ Screech", "movie_screech")],
        [Markup.button.callback("üé¨ Jujutsu Kaisen 0", "movie_jujutsu"), Markup.button.callback("üé¨ One Piece Red", "movie_opred")],
        [Markup.button.callback("üé¨ Dangal", "movie_dangal"), Markup.button.callback("üé¨ Borbadd", "movie_bor")],
        [Markup.button.callback("‚¨ÖÔ∏è Back to Main Menu", "main_menu")]
    ]));
});

bot.action('show_anime', async (ctx) => {
    await ctx.answerCbQuery();
    await ctx.editMessageText("üéå ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶Æ‡ßá ‡¶∏‡¶ø‡¶∞‡¶ø‡¶ú ‡¶¨‡¶æ‡¶õ‡ßÅ‡¶®:", Markup.inlineKeyboard([
        [Markup.button.callback("üç• Naruto", "anime_naruto"), Markup.button.callback("üç• Naruto Shippuden", "anime_naruto_shi")],
        [Markup.button.callback("üç• Lookism", "anime_lookism"), Markup.button.callback("üç• Jujutsu Kaisen", "anime_jujutsu")],
        [Markup.button.callback("‚öîÔ∏è Attack on Titan", "anime_aot"), Markup.button.callback("üî• Demon Slayer", "anime_demonslayer")],
        [Markup.button.callback("üêâ Dragon Ball", "anime_dbz"), Markup.button.callback("üç• Solo Leveling", "anime_solo")],
        [Markup.button.callback("‚¨ÖÔ∏è Back to Main Menu", "main_menu")]
    ]));
});

bot.action('main_menu', async (ctx) => {
    await ctx.answerCbQuery();
    await ctx.editMessageText("What do you want to download?", Markup.inlineKeyboard([
        [Markup.button.callback("üé¨ Movie", "show_movie")],
        [Markup.button.callback("üç• Anime", "show_anime")]
    ]));
});

const seasonMenus = {
    'anime_naruto_shi': { name: 'Naruto Shippuden', seasons: 9 }, 'anime_naruto': { name: 'Naruto', seasons: 9 },
    'anime_aot': { name: 'Attack on Titan', seasons: 4 }, 'anime_demonslayer': { name: 'Demon Slayer', seasons: 4, key: 'demon' },
    'anime_dbz': { name: 'Dragon Ball', seasons: 5, key: 'db' }, 'anime_solo': { name: 'Solo Leveling', seasons: 2, key: 'solo' },
    'anime_lookism': { name: 'Lookism', seasons: 1 }, 'anime_jujutsu': { name: 'Jujutsu Kaisen', seasons: 2, key: 'juju' },
};

for (const [action, config] of Object.entries(seasonMenus)) {
    bot.action(action, async (ctx) => {
        await ctx.answerCbQuery();
        const buttons = Array.from({ length: config.seasons }, (_, i) => {
            const key = config.key || action.split('_')[1];
            return Markup.button.callback(`${config.name} Season ${i + 1}`, `${key}_s${i + 1}`);
        });
        const keyboard = [];
        for (let i = 0; i < buttons.length; i += 2) {
            keyboard.push(buttons.slice(i, i + 2));
        }
        keyboard.push([Markup.button.callback("‚¨ÖÔ∏è Back to Anime List", "show_anime")]);
        await ctx.editMessageText(`üì∫ ${config.name}-‡¶è‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶ø‡¶ú‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®:`, Markup.inlineKeyboard(keyboard));
    });
}

bot.action(/^([a-z]+)_s(\d+)$/, async (ctx) => {
    await ctx.answerCbQuery();
    const key = ctx.match[0];
    const name = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    if (LINK_MOVIE_ANIME_IDS[key]) {
        await sendEpisodes(ctx, LINK_MOVIE_ANIME_IDS[key], name);
    } else {
        await ctx.reply("‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶è‡¶á ‡¶∏‡¶ø‡¶ú‡¶®‡¶ü‡¶ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§");
    }
});

bot.action(/^movie_([a-z]+)$/, async (ctx) => {
    await ctx.answerCbQuery();
    const key = ctx.match[1];
    const name = key.charAt(0).toUpperCase() + key.slice(1);
    if (LINK_MOVIE_ANIME_IDS[key]) {
        await sendMovie(ctx, LINK_MOVIE_ANIME_IDS[key], name);
    } else {
        await ctx.reply("‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶è‡¶á ‡¶Æ‡ßÅ‡¶≠‡¶ø‡¶ü‡¶ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§");
    }
});

// ‡¶¨‡¶ü ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
bot.launch();
console.log('‚úÖ Bot is running...');

process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));
